<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Listening</title>
  <style type="text/css">
    #color {
      height: 100px;
    }
  </style>
</head>
<body>
  <button id="listen">Start Listening</button>
  <div id="color"></div>
  <canvas id="analyser" width="1024" height="500"></canvas>
  <div id="log"></div>
    <!-- script src="AudioContextMonkeyPatch.js"></script -->
<script type="text/javascript">
  audioContext = new webkitAudioContext();
  analyserContext = null;
  inputPoint = null;
  rafID = null;
  color = document.getElementById('color');
  log = document.getElementById('log');
  start = 0;


  function updateAnalysers(time) {

    if (!analyserContext) {
        var canvas = document.getElementById("analyser");
        canvasWidth = canvas.width;
        canvasHeight = canvas.height;
        analyserContext = canvas.getContext('2d');
    }

    var freqByteData = new Uint8Array(analyserNode.frequencyBinCount);
    analyserNode.getByteFrequencyData(freqByteData);

    var samplerate = audioContext.sampleRate;
    var fftsize = analyserNode.fftSize = 2048;
    var freq = 2000;

    var sound = freqByteData[Math.round(freq * fftsize / samplerate)];
    // sound += freqByteData[Math.round(freq * 2 * fftsize / samplerate)];
    // sound += freqByteData[Math.round(freq * 4 * fftsize / samplerate)];
    // sound /= 3;

    console.log(sound);
    color.style.backgroundColor = 'rgb(' + sound +',40,40)';

    if (sound > 240) {
      log.innerHTML += '<br>done';
      console.log('done');
    }

    analyserContext.fillStyle = '#000000';
    analyserContext.fillRect((Date.now() - start)/20, canvasHeight, 1, -sound);

    if (((Date.now() - start)/20) > canvasWidth) {
      analyserContext.clearRect(0, 0, canvasWidth, canvasHeight);
      start = Date.now();
    }

    rafID = window.requestAnimationFrame( updateAnalysers );
}

  function gotStream(stream) {
    inputPoint = audioContext.createGain();

    // Create an AudioNode from the stream.
    audioInput = audioContext.createMediaStreamSource(stream);
    audioInput.connect(inputPoint);

    analyserNode = audioContext.createAnalyser();
    analyserNode.fftSize = 2048;
    inputPoint.connect( analyserNode );

    zeroGain = audioContext.createGain();
    zeroGain.gain.value = 0.0;
    inputPoint.connect( zeroGain );
    zeroGain.connect( audioContext.destination );
    updateAnalysers();
    start = Date.now();
  }

  document.getElementById('listen').addEventListener(
    'click',
    function(e){
      navigator.webkitGetUserMedia(
        {audio:true},
        gotStream,
        function(e) {
          alert('Error getting audio');
          console.log(e);
        }
      );
    }
  );
</script>
  </body>
</html>